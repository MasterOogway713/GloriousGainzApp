<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Turkey Shred '26</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #09090b; color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom, 16px); }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    @keyframes scroll-whisper {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .whisper-scroll {
      display: inline-block;
      white-space: nowrap;
      animation: scroll-whisper 30s linear infinite;
      will-change: transform;
    }
    input[type=range] { -webkit-appearance: none; background: transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #f97316; cursor: pointer; margin-top: -8px; border: 2px solid #fff; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #27272a; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, doc, setDoc, updateDoc, deleteField, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const { useState, useEffect, useMemo, useRef } = React;

    // ==========================================
    // ðŸ› ï¸ FIREBASE SETUP & GLOBALS
    // ==========================================
    const defaultFirebaseConfig = {
      apiKey: "AIzaSyBXshCysVDRwvAOCvvnaqYNbAYjtdl3Wz4",
      authDomain: "gloriousgainzapp.firebaseapp.com",
      projectId: "gloriousgainzapp",
      storageBucket: "gloriousgainzapp.firebasestorage.app",
      messagingSenderId: "620249838291",
      appId: "1:620249838291:web:784bdc3e4ff188ebb21a26"
    };

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : defaultFirebaseConfig;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'gloriousgainzapp';
    const apiKey = typeof __gemini_api_key !== 'undefined' ? __gemini_api_key : "";
    
    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);

    const DB_URL = "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/dist/exercises.json";
    const IMG_BASE_URL = "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/";

    const TEMPLATES = {
      "Chest/Tris": ["Bench Press", "Incline Dumbbell Press", "Pec Deck", "Tricep Extension", "Skullcrushers", "Dips"],
      "Back/Biceps": ["Pull-ups", "Barbell Row", "Lat Pulldown", "Seated Cable Row", "Dumbbell Curl", "Hammer Curl"],
      "Shoulders/Abs": ["Overhead Press", "Lateral Raises", "Front Raise", "Face Pulls", "Crunch", "Plank", "Cable Woodchop"],
      "Legs": ["Leg Press", "Leg Extension", "Hamstring Curl", "Calf Raise", "Lunges"],
      "Other": ["Hip Thrust", "Farmers Walk", "Shrugs", "Clean and Jerk", "Snatch"]
    };
    const REP_TARGETS = [4, 8, 10, 12, 15, 20, 30];

    // --- ICONS ---
    const IconTrophy = ({className, size=24}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7c0 3.31 2.69 6 6 6s6-2.69 6-6V2Z"/></svg>;
    const IconPlus = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
    const IconSearch = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;
    const IconX = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
    const IconActivity = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>;
    const IconFlame = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>;
    const IconUtensils = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>;
    const IconCalendar = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
    const IconUser = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
    const IconMessageCircle = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>;
    const IconTimer = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
    const IconBan = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg>;
    const IconZap = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
    const IconTrash = ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;

    // --- HELPERS ---
    const formatDate = (dateObj) => dateObj.toISOString().split('T')[0];

    // --- SCREENS ---
    function WelcomeScreen({ onSelect }) {
      const whisperText = "The glorious house of gains... ".repeat(30);
      return (
        <div className="relative min-h-screen bg-zinc-950 flex flex-col items-center justify-center p-6 text-center overflow-hidden">
          <div className="absolute inset-0 z-0 pointer-events-none flex flex-col justify-around overflow-hidden opacity-[0.03] select-none">
            {[30, 40, 25, 50, 35].map((speed, i) => (
              <div key={i} className="whisper-scroll text-6xl font-black italic text-white" style={{ animationDuration: `${speed}s`, animationDirection: i % 2 === 0 ? 'normal' : 'reverse' }}>{whisperText}</div>
            ))}
          </div>
          <div className="relative z-10 flex flex-col items-center w-full">
            <div className="bg-orange-500/10 p-4 rounded-full mb-6 border border-orange-500/20 backdrop-blur-md">
              <IconTrophy className="text-orange-500 w-12 h-12" />
            </div>
            <h1 className="text-4xl font-black italic tracking-tighter mb-2 uppercase text-white leading-tight">Turkey Shred <span className="text-orange-500">'26</span></h1>
            <p className="text-zinc-400 mb-12 font-medium">Who is grinding today?</p>
            <div className="flex gap-4 w-full max-w-sm">
              <button onClick={() => onSelect('Jordan')} className="flex-1 bg-zinc-900 border border-zinc-800 hover:border-blue-500 py-8 rounded-3xl font-black text-xl text-white transition-all active:scale-95 flex flex-col items-center gap-3 shadow-2xl">
                <div className="w-14 h-14 bg-blue-500/20 rounded-full flex items-center justify-center text-blue-500 text-2xl font-black border border-blue-500/30">J</div> Jordan
              </button>
              <button onClick={() => onSelect('Aaron')} className="flex-1 bg-zinc-900 border border-zinc-800 hover:border-emerald-500 py-8 rounded-3xl font-black text-xl text-white transition-all active:scale-95 flex flex-col items-center gap-3 shadow-2xl">
                <div className="w-14 h-14 bg-emerald-500/20 rounded-full flex items-center justify-center text-emerald-500 text-2xl font-black border border-emerald-500/30">A</div> Aaron
              </button>
            </div>
          </div>
        </div>
      );
    }

    function Header({ localUser }) {
      const [daysLeft, setDaysLeft] = useState(0);
      useEffect(() => {
        const target = new Date('2026-04-25T00:00:00').getTime();
        const update = () => setDaysLeft(Math.floor((target - Date.now()) / (1000 * 60 * 60 * 24)));
        update();
      }, []);
      return (
        <div className="sticky top-0 z-50 bg-zinc-950/80 backdrop-blur-xl border-b border-zinc-800/50 px-4 py-3 flex justify-between items-center">
          <div>
            <h1 className="text-xl font-black italic tracking-tighter uppercase">Turkey<span className="text-orange-500">Shred</span></h1>
            <div className="text-[10px] font-black text-zinc-500 uppercase tracking-widest flex items-center gap-1.5">
              <div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div> Live as {localUser}
            </div>
          </div>
          <div className="bg-zinc-900 px-3 py-1.5 rounded-2xl border border-zinc-800 flex items-center gap-2">
            <IconCalendar className="w-4 h-4 text-orange-500" />
            <div className="text-sm font-black italic">{daysLeft} <span className="text-[9px] text-zinc-500">DAYS</span></div>
          </div>
        </div>
      );
    }

    function Gauntlet({ gauntlet, localUser }) {
      const [isComposing, setIsComposing] = useState(false);
      const [proposals, setProposals] = useState({});
      const [selectedMatch, setSelectedMatch] = useState(null);

      const rival = localUser === 'Jordan' ? 'Aaron' : 'Jordan';
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

      const toggleDay = (d) => {
        setProposals(prev => {
          const next = { ...prev };
          if (next[d]) delete next[d];
          else next[d] = { time: '', certainty: 'Potential' };
          return next;
        });
      };

      const handleSend = async () => {
        if (Object.keys(proposals).length === 0) return;
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gauntlet', 'current'), {
          challenger: localUser,
          target: rival,
          proposals,
          status: 'pending',
          timestamp: Date.now()
        });
        setIsComposing(false);
        setProposals({});
      };

      const handleAccept = async () => {
        if (!selectedMatch) return;
        const prop = gauntlet.proposals[selectedMatch];
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gauntlet', 'current'), {
          status: 'accepted',
          lockedDay: selectedMatch,
          lockedTime: prop.time || 'TBD',
          lockedCertainty: prop.certainty
        });
      };

      const handleClear = async () => {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gauntlet', 'current'));
      };

      const handleCounter = async () => {
        await handleClear();
        setIsComposing(true);
      };

      if (!gauntlet) {
        return (
          <div className="mb-8">
            {!isComposing ? (
              <button onClick={() => setIsComposing(true)} className="w-full bg-zinc-900 border border-zinc-800 hover:border-orange-500 hover:bg-orange-500/10 text-zinc-400 hover:text-orange-500 font-black uppercase tracking-widest py-4 rounded-[2rem] transition-all flex items-center justify-center gap-2 shadow-lg">
                <IconCalendar size={20} /> Schedule A Gym Sesh
              </button>
            ) : (
              <div className="bg-zinc-900 p-5 rounded-[2rem] border border-orange-500/50 shadow-[0_0_20px_rgba(249,115,22,0.15)] animate-in fade-in zoom-in-95 duration-300">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <span className="text-xs font-black uppercase text-orange-500 tracking-widest block">Choose Availability</span>
                    <span className="text-[10px] text-zinc-400">Select the days you can make it.</span>
                  </div>
                  <button onClick={() => {setIsComposing(false); setProposals({});}} className="text-zinc-500 hover:text-white"><IconX size={20} /></button>
                </div>
                
                <div className="flex gap-2 overflow-x-auto hide-scrollbar pb-3 mb-2">
                  {days.map(d => {
                    const isSelected = !!proposals[d];
                    return (
                      <button key={d} onClick={() => toggleDay(d)} className={`flex-1 min-w-[3.5rem] font-black py-2 rounded-xl transition-all border ${isSelected ? 'bg-orange-500 text-black border-orange-400 shadow-md' : 'bg-black border-zinc-800 text-zinc-400 hover:border-orange-500/50'}`}>
                        {d}
                      </button>
                    )
                  })}
                </div>

                {Object.keys(proposals).length > 0 && (
                  <div className="space-y-3 mb-4 animate-in fade-in slide-in-from-top-2">
                    {Object.entries(proposals).map(([day, details]) => (
                      <div key={day} className="bg-black/50 p-3 rounded-2xl border border-zinc-800 flex flex-col gap-2">
                        <div className="flex justify-between items-center">
                          <span className="font-black text-orange-500">{day}</span>
                          <div className="flex bg-zinc-900 rounded-lg p-1 border border-zinc-800">
                            <button onClick={() => setProposals(p => ({...p, [day]: {...p[day], certainty: 'Potential'}}))} className={`px-2 py-1 rounded-md text-[10px] font-bold uppercase transition-all ${details.certainty === 'Potential' ? 'bg-zinc-700 text-white' : 'text-zinc-500'}`}>Potential</button>
                            <button onClick={() => setProposals(p => ({...p, [day]: {...p[day], certainty: 'Definite'}}))} className={`px-2 py-1 rounded-md text-[10px] font-bold uppercase transition-all ${details.certainty === 'Definite' ? 'bg-emerald-600 text-white' : 'text-zinc-500'}`}>Definite</button>
                          </div>
                        </div>
                        <label className="flex items-center gap-2 bg-zinc-900 border border-zinc-700 rounded-xl px-3 py-2 focus-within:border-orange-500 transition-all cursor-pointer">
                          <IconTimer size={16} className="text-orange-500 shrink-0" />
                          <input 
                            type="time" 
                            value={details.time}
                            onChange={(e) => setProposals(p => ({...p, [day]: {...p[day], time: e.target.value}}))}
                            className="w-full bg-transparent text-sm text-white outline-none font-bold font-mono cursor-pointer m-0 p-0"
                            style={{ colorScheme: 'dark' }}
                          />
                        </label>
                      </div>
                    ))}
                  </div>
                )}

                <button 
                  disabled={Object.keys(proposals).length === 0}
                  onClick={handleSend}
                  className="w-full bg-orange-500 text-black font-black uppercase tracking-widest py-3 rounded-2xl transition-all shadow-lg active:scale-95 disabled:opacity-50 disabled:active:scale-100"
                >
                  Send Invite
                </button>
              </div>
            )}
          </div>
        );
      }

      if (gauntlet.status === 'pending') {
        if (gauntlet.challenger === localUser) {
          return (
            <div className="mb-8 bg-zinc-900/80 border border-zinc-800 p-5 rounded-[2rem] shadow-lg relative overflow-hidden">
              <div className="absolute inset-0 bg-orange-500/5 animate-pulse pointer-events-none"></div>
              <div className="flex justify-between items-start mb-3 relative z-10">
                <div className="text-[10px] font-black uppercase tracking-widest text-orange-500 flex items-center gap-1.5"><IconCalendar size={14} className="animate-pulse" /> Invite Sent</div>
                <button onClick={handleClear} className="text-zinc-500 hover:text-red-500 transition-colors"><IconX size={16} /></button>
              </div>
              <div className="text-sm font-bold text-white mb-3 relative z-10">Waiting on <span className="text-orange-500 italic">{rival}</span> to see if they can do these date(s)...</div>
              <div className="flex flex-wrap gap-2 relative z-10">
                {Object.entries(gauntlet.proposals || {}).map(([day, details]) => (
                   <div key={day} className="bg-black border border-zinc-800 px-3 py-2 rounded-xl text-xs flex flex-col flex-1 min-w-[30%]">
                     <span className="font-black text-white">{day} <span className="text-zinc-500 font-normal">{details.time && `@ ${details.time}`}</span></span>
                     <span className={`text-[9px] font-bold uppercase mt-1 ${details.certainty === 'Definite' ? 'text-emerald-500' : 'text-zinc-500'}`}>{details.certainty}</span>
                   </div>
                ))}
              </div>
            </div>
          );
        } else {
          return (
            <div className="mb-8 bg-gradient-to-br from-zinc-900 to-zinc-950 border border-orange-500/50 p-5 rounded-[2rem] shadow-[0_0_30px_rgba(249,115,22,0.2)] animate-in slide-in-from-top-4 relative overflow-hidden">
              <div className="absolute -top-10 -right-4 opacity-5 text-orange-500 pointer-events-none"><IconCalendar size={100} /></div>
              <div className="text-[10px] font-black uppercase tracking-widest text-orange-500 mb-1 flex items-center gap-1.5"><IconCalendar size={14} className="animate-pulse" /> Gym Sesh Proposed</div>
              <div className="text-base font-bold text-white mb-4 leading-tight"><span className="text-orange-500 font-black italic">{gauntlet.challenger}</span> wants to train. Select a date that works or counter.</div>
              
              <div className="space-y-2 mb-4 relative z-10">
                {Object.entries(gauntlet.proposals || {}).map(([day, details]) => (
                   <button 
                     key={day} 
                     onClick={() => setSelectedMatch(day)}
                     className={`w-full text-left px-4 py-3 rounded-xl border flex justify-between items-center transition-all ${selectedMatch === day ? 'bg-orange-500/10 border-orange-500' : 'bg-black/50 border-zinc-800 hover:border-zinc-600'}`}
                   >
                     <div>
                       <div className={`font-black ${selectedMatch === day ? 'text-orange-500' : 'text-white'}`}>{day}</div>
                       <div className="text-[10px] font-bold uppercase text-zinc-500 mt-0.5">{details.time ? `Time: ${details.time}` : 'Time: TBD'}</div>
                     </div>
                     <span className={`text-[9px] font-black uppercase px-2 py-1 rounded-md ${details.certainty === 'Definite' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-zinc-800 text-zinc-400'}`}>{details.certainty}</span>
                   </button>
                ))}
              </div>

              <div className="flex gap-3 relative z-10">
                <button disabled={!selectedMatch} onClick={handleAccept} className="flex-1 bg-orange-500 text-black font-black uppercase py-3 rounded-2xl shadow-lg active:scale-95 transition-all text-sm tracking-widest disabled:opacity-50 disabled:scale-100">Lock It In</button>
                <button onClick={handleCounter} className="flex-[0.5] bg-zinc-950 border border-zinc-700 hover:border-zinc-500 text-white font-bold uppercase py-3 rounded-2xl active:scale-95 transition-all text-xs tracking-wider">Counter</button>
              </div>
            </div>
          );
        }
      }

      if (gauntlet.status === 'accepted') {
        return (
          <div className="mb-8 bg-gradient-to-br from-yellow-500/20 to-orange-600/20 border border-yellow-500/50 p-6 rounded-[2.5rem] shadow-[0_0_40px_rgba(234,179,8,0.2)] relative overflow-hidden flex flex-col gap-3">
            <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPjwvc3ZnPg==')] opacity-50 pointer-events-none"></div>
            
            <div className="relative z-10 flex justify-between items-start">
              <div>
                <div className="text-[10px] font-black uppercase tracking-[0.2em] text-yellow-500 mb-1 flex items-center gap-2"><IconTrophy size={14} /> Iron Pact Secured</div>
                <div className="text-2xl font-black text-white italic">{gauntlet.lockedDay}</div>
                <div className="text-sm font-bold text-yellow-400">{gauntlet.lockedTime} <span className="text-zinc-400 mx-1">â€¢</span> <span className="uppercase text-[10px] tracking-widest">{gauntlet.lockedCertainty}</span></div>
              </div>
              <button onClick={handleClear} className="bg-black/50 border border-yellow-500/30 text-yellow-500 hover:bg-yellow-500 hover:text-black w-8 h-8 flex justify-center items-center rounded-full transition-all shadow-lg active:scale-95"><IconX size={14} /></button>
            </div>
          </div>
        );
      }

      return null;
    }

    function Feed({ workouts, habits, localUser }) {
      const [commentText, setCommentText] = useState({});
      const [showComments, setShowComments] = useState({});
      
      const allEvents = useMemo(() => {
        const evts = [...workouts.map(w => ({ ...w, type: 'workout' })), ...habits.map(h => ({ ...h, type: 'habit' }))].sort((a, b) => b.timestamp - a.timestamp);
        const groups = {}; const result = [];
        evts.forEach(evt => {
          if (evt.type === 'workout') {
            // Group by User + Date to combine entire sessions
            const key = `${evt.user}-${evt.date}`;
            if (!groups[key]) {
              groups[key] = { 
                id: key, 
                primaryDocId: evt.id, 
                type: 'workoutGroup', 
                user: evt.user, 
                date: evt.date, 
                timestamp: evt.timestamp, 
                exercises: {}, 
                reactions: evt.reactions || {}, 
                comments: evt.comments || [],
                totalSets: 0
              };
              result.push(groups[key]);
            }
            if (!groups[key].exercises[evt.exercise]) {
               groups[key].exercises[evt.exercise] = [];
            }
            groups[key].exercises[evt.exercise].push(evt);
            groups[key].totalSets++;
          } else { result.push(evt); }
        });
        return result;
      }, [workouts, habits]);

      const handleReact = async (evt, emoji) => {
        const col = evt.type === 'workoutGroup' ? 'workouts' : 'habits';
        const docId = evt.type === 'workoutGroup' ? evt.primaryDocId : evt.id;
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', col, docId), { [`reactions.${localUser}`]: emoji || deleteField() });
        } catch(e) {}
      };

      const handleAddComment = async (evt) => {
        const txt = commentText[evt.id]; if (!txt?.trim()) return;
        const col = evt.type === 'workoutGroup' ? 'workouts' : 'habits';
        const docId = evt.type === 'workoutGroup' ? evt.primaryDocId : evt.id;
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', col, docId), { comments: arrayUnion({ user: localUser, text: txt.trim(), timestamp: Date.now() }) });
          setCommentText({ ...commentText, [evt.id]: '' });
        } catch(e) {}
      };

      return (
        <div className="space-y-4 pb-24">
          <h2 className="text-xs font-black text-zinc-500 uppercase tracking-[0.2em] mb-4">Activity Stream</h2>
          {allEvents.length === 0 ? (
            <div className="text-center p-8 bg-zinc-900/50 rounded-2xl border border-zinc-800 text-zinc-500">No activity yet. Set the tone!</div>
          ) : (
            allEvents.map(evt => {
              const isMe = evt.user === localUser;
              const theme = evt.user === 'Jordan' ? 'blue' : 'emerald';
              return (
                <div key={evt.id} className={`p-5 rounded-3xl border transition-all ${isMe ? 'border-zinc-800 bg-zinc-900/40' : `border-${theme}-500/20 bg-${theme}-500/5 shadow-2xl`}`}>
                  <div className="flex justify-between items-start mb-4">
                    <div className="flex items-center gap-2.5">
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-black border border-${theme}-500/30 text-${theme}-500 bg-${theme}-500/10 shadow-inner`}>{evt.user.charAt(0)}</div>
                      <div>
                        <span className="font-black text-sm block">{evt.user}</span>
                        <span className="text-[10px] text-zinc-500 font-bold uppercase tracking-wide">
                          {evt.type === 'workoutGroup' ? `Smashed a Session (${evt.totalSets} Sets)` : 'Habit Check-In'}
                        </span>
                      </div>
                    </div>
                    <span className="text-[10px] font-bold text-zinc-600">{new Date(evt.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                  </div>
                  
                  <div className="pl-10">
                    {evt.type === 'workoutGroup' ? (
                      <div className="space-y-4">
                        {Object.entries(evt.exercises).map(([exName, sets]) => (
                          <div key={exName} className="mb-2">
                             <h3 className="font-black text-base text-white italic mb-2 leading-tight underline decoration-orange-500/50 underline-offset-4">{exName}</h3>
                             <div className="space-y-1.5 pl-3 border-l-2 border-zinc-800/50">
                               {[...sets].reverse().map((s, i) => (
                                 <div key={s.id} className="flex flex-col gap-1">
                                   <div className="bg-zinc-950 px-3 py-1.5 rounded-xl border border-zinc-800/50 w-fit font-mono text-xs text-orange-400 font-bold">
                                     <span className="text-zinc-500 font-sans mr-1">Set {i+1}:</span> <span className="text-white">{s.weight}kg</span> x {s.reps}
                                   </div>
                                   {s.note && <div className="text-[10px] text-zinc-400 italic pl-1">"{s.note}"</div>}
                                 </div>
                               ))}
                             </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="flex flex-wrap gap-1.5 pt-1">
                        {['calories','protein','water','noAlcohol'].map(h => evt[h] && <span key={h} className="text-[9px] bg-zinc-800 text-zinc-300 px-2.5 py-1 rounded-full font-black uppercase tracking-wider border border-zinc-700">âœ“ {h}</span>)}
                      </div>
                    )}
                    
                    <div className="flex gap-2 mt-5 pt-4 border-t border-zinc-800/50">
                      {['ðŸ”¥', 'ðŸ’ª', 'ðŸ', 'ðŸ¤¡'].map(emoji => (
                        <button key={emoji} onClick={() => handleReact(evt, evt.reactions?.[localUser] === emoji ? null : emoji)} className={`px-3 py-1 rounded-full text-xs border transition-all ${evt.reactions?.[localUser] === emoji ? 'bg-orange-500/20 border-orange-500' : 'bg-zinc-800/50 border-zinc-800 opacity-60'}`}>{emoji} <span className="font-black ml-1">{Object.values(evt.reactions || {}).filter(e => e === emoji).length || ''}</span></button>
                      ))}
                    </div>

                    <div className="mt-4">
                      <button onClick={() => setShowComments({...showComments, [evt.id]: !showComments[evt.id]})} className="text-[10px] text-zinc-500 flex items-center gap-1.5 font-black uppercase tracking-widest hover:text-white transition-all"><IconMessageCircle size={14} /> {evt.comments?.length || 0} Comments</button>
                      {showComments[evt.id] && <div className="mt-4 space-y-3 pl-4 border-l-2 border-zinc-800 animate-in slide-in-from-left-2 duration-300">
                        {evt.comments?.map((c, i) => <div key={i} className="text-xs"><span className={`font-black ${c.user === 'Jordan' ? 'text-blue-500' : 'text-emerald-500'}`}>{c.user}: </span><span className="text-zinc-300 font-medium">{c.text}</span></div>)}
                        <div className="flex gap-2 pt-2"><input value={commentText[evt.id] || ''} onChange={e => setCommentText({...commentText, [evt.id]: e.target.value})} placeholder="Write a comment..." className="flex-1 bg-black border border-zinc-800 rounded-xl px-3 py-2 text-xs text-white outline-none focus:border-orange-500 transition-all" /><button onClick={() => handleAddComment(evt)} className="bg-zinc-800 px-4 rounded-xl text-xs font-black uppercase text-zinc-400 hover:text-white transition-colors">Post</button></div>
                      </div>}
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      );
    }

    function ExerciseSearchModal({ onClose, onSelect, exerciseDB, customExercises }) {
      const [query, setQuery] = useState('');
      const allExercises = useMemo(() => [...(customExercises || []).map(c => ({ name: c.name, isCustom: true })), ...(exerciseDB || [])], [exerciseDB, customExercises]);
      const results = useMemo(() => query ? allExercises.filter(ex => ex.name.toLowerCase().includes(query.toLowerCase())).slice(0, 30) : allExercises.slice(0, 20), [query, allExercises]);
      return (
        <div className="fixed inset-0 bg-black/95 z-[60] flex flex-col p-4 animate-in fade-in backdrop-blur-sm">
          <div className="w-full max-w-md mx-auto h-full flex flex-col bg-zinc-950 border border-zinc-800 rounded-[2rem] overflow-hidden mt-4 shadow-2xl">
            <div className="flex justify-between items-center p-6 border-b border-zinc-900 bg-zinc-900/50"><h3 className="font-black text-xl italic uppercase">Gains Database</h3><button onClick={onClose} className="p-2 bg-zinc-800 rounded-full hover:bg-zinc-700 transition-all"><IconX size={20}/></button></div>
            <div className="p-6 border-b border-zinc-900"><input value={query} onChange={e => setQuery(e.target.value)} placeholder="Search exercises..." className="w-full bg-black border border-zinc-800 rounded-2xl py-4 px-5 text-white font-bold focus:border-orange-500 outline-none shadow-inner transition-all" autoFocus /></div>
            <div className="flex-1 overflow-y-auto p-3 space-y-2">
              {results.length ? results.map(ex => (
                <button key={ex.name} onClick={() => onSelect(ex.name)} className="w-full flex items-center gap-4 p-4 rounded-2xl bg-zinc-900/30 border border-zinc-800/50 hover:bg-zinc-800 transition-all text-left">
                  <div className="w-12 h-12 rounded-xl bg-zinc-900 border border-zinc-800 flex items-center justify-center shrink-0 text-zinc-600"><IconActivity size={20}/></div>
                  <div><div className="font-black text-white italic">{ex.name}</div><div className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">{ex.isCustom ? 'Custom Entry' : ex.category}</div></div>
                </button>
              )) : <div className="p-10 text-center"><button onClick={async () => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'custom_exercises'), { name: query.trim() }); onSelect(query.trim()); }} className="bg-orange-500 text-black font-black uppercase px-6 py-4 rounded-2xl shadow-lg animate-pulse transition-all active:scale-95">Add "{query}" as Custom</button></div>}
            </div>
          </div>
        </div>
      );
    }

    function Train({ workouts, localUser, exerciseDB, customExercises }) {
      const [activeTemplate, setActiveTemplate] = useState("Chest/Tris");
      const [exercise, setExercise] = useState(TEMPLATES["Chest/Tris"][0]);
      const [weight, setWeight] = useState('');
      const [reps, setReps] = useState('10');
      const [note, setNote] = useState('');
      const [showSearchModal, setShowSearchModal] = useState(false);
      const [restTime, setRestTime] = useState(0);
      const [showPastSets, setShowPastSets] = useState(false);

      const rival = localUser === 'Jordan' ? 'Aaron' : 'Jordan';
      const today = formatDate(new Date());

      useEffect(() => { if (restTime > 0) { const t = setInterval(() => setRestTime(r => r - 1), 1000); return () => clearInterval(t); } }, [restTime]);

      const todaysWorkouts = useMemo(() => {
        return workouts.filter(w => w.user === localUser && w.date === today).sort((a,b) => b.timestamp - a.timestamp);
      }, [workouts, localUser, today]);

      const lastSets = useMemo(() => {
        const past = workouts.filter(w => w.user === localUser && w.exercise === exercise && w.date !== today).sort((a,b) => b.timestamp - a.timestamp);
        if (!past.length) return [];
        const lastDate = past[0].date;
        return past.filter(p => p.date === lastDate).reverse();
      }, [workouts, localUser, exercise, today]);

      const myPB = useMemo(() => {
        const sets = workouts.filter(w => w.user === localUser && w.exercise === exercise);
        return sets.length ? sets.reduce((max, curr) => curr.weight > max.weight ? curr : max, sets[0]) : null;
      }, [workouts, localUser, exercise]);

      const rivalPB = useMemo(() => {
        const sets = workouts.filter(w => w.user === rival && w.exercise === exercise);
        return sets.length ? sets.reduce((max, curr) => curr.weight > max.weight ? curr : max, sets[0]) : null;
      }, [workouts, rival, exercise]);

      const handleLog = async (e) => {
        e.preventDefault();
        if (!weight || !reps || !exercise) return;
        try {
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'workouts'), { user: localUser, exercise, weight: parseFloat(weight), reps: parseInt(reps, 10), note: note.trim(), date: today, timestamp: Date.now() });
          setWeight(''); setNote(''); setRestTime(90);
        } catch(err) {}
      };

      const handleDeleteSet = async (id) => {
         try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'workouts', id));
         } catch(err) {}
      };

      const suggestedExercises = useMemo(() => {
        const baseList = TEMPLATES[activeTemplate] || [];
        const getLast = (ex) => { const m = workouts.filter(w => w.user === localUser && w.exercise === ex); return m.length ? Math.max(...m.map(w => w.timestamp)) : 0; };
        return [...baseList].sort((a, b) => getLast(b) - getLast(a));
      }, [activeTemplate, workouts, localUser]);

      return (
        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 pb-24">
          {restTime > 0 && <div className="fixed bottom-[80px] left-1/2 -translate-x-1/2 bg-zinc-950 border border-orange-500 text-orange-500 px-6 py-4 rounded-full font-mono text-2xl font-black shadow-[0_0_30px_rgba(249,115,22,0.3)] z-50 flex items-center gap-4 animate-bounce">
            <IconTimer size={24} /> {Math.floor(restTime/60)}:{(restTime%60).toString().padStart(2, '0')}
            <button onClick={() => setRestTime(0)} className="text-zinc-600 ml-2 hover:text-white"><IconX size={20}/></button>
          </div>}

          <h2 className="text-3xl font-black italic uppercase text-white mb-6">Log Set</h2>
          <div className="bg-zinc-900 p-6 rounded-[2.5rem] border border-zinc-800 shadow-2xl relative overflow-hidden">
            <form onSubmit={handleLog} className="space-y-5 relative z-10">
              <div>
                <label className="text-[10px] font-black text-zinc-500 uppercase tracking-widest block mb-2">Select Split</label>
                <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar snap-x">
                  {Object.keys(TEMPLATES).map(t => (
                    <button key={t} type="button" onClick={() => {setActiveTemplate(t); setExercise(TEMPLATES[t][0]);}} className={`whitespace-nowrap px-4 py-2 rounded-2xl text-xs font-black border transition-all snap-start ${activeTemplate === t ? 'bg-orange-500 text-black border-orange-400' : 'bg-zinc-950 text-zinc-500 border-zinc-800'}`}>{t}</button>
                  ))}
                </div>
              </div>

              <div className="h-px bg-zinc-800"></div>

              <div>
                <button type="button" onClick={() => setShowSearchModal(true)} className="w-full bg-black border border-zinc-800 rounded-2xl p-4 text-white font-black text-left flex justify-between items-center transition-all hover:border-orange-500/50 shadow-inner">
                  <span className="truncate">{exercise || "Select Exercise..."}</span> <IconSearch size={20} className="text-orange-500" />
                </button>
                <div className="flex flex-wrap gap-2 mt-3">
                  {suggestedExercises.map(ex => (
                    <button type="button" key={ex} onClick={() => setExercise(ex)} className={`text-[10px] px-3 py-1.5 rounded-xl font-black transition-all border ${exercise === ex ? 'bg-orange-500/10 text-orange-500 border-orange-500/40' : 'bg-zinc-800/50 text-zinc-500 border-transparent hover:border-zinc-700'}`}>{ex}</button>
                  ))}
                </div>
              </div>

              <div className="bg-black/50 rounded-3xl p-4 border border-zinc-800 shadow-inner">
                <div className="flex justify-between items-center mb-3">
                  <span className="text-[10px] font-black text-zinc-500 uppercase tracking-widest flex items-center gap-1.5">ðŸŽ¯ TARGET TO BEAT</span>
                  <button type="button" onClick={() => setShowPastSets(!showPastSets)} className="text-[10px] text-orange-500 font-black uppercase tracking-tighter bg-orange-500/10 px-2 py-1 rounded-lg hover:bg-orange-500/20 transition-all">{showPastSets ? 'Hide' : 'Show Sets'}</button>
                </div>
                {lastSets.length ? (
                  <div className="flex flex-col gap-2">
                    {showPastSets ? lastSets.map((s, i) => (
                      <div key={i} className="flex justify-between text-sm text-zinc-300 font-mono font-bold bg-zinc-900/50 px-3 py-1 rounded-lg border border-zinc-800/50"><span>Set {i+1}</span> <span>{s.weight}kg x {s.reps}</span></div>
                    )) : (
                      <div className="text-base font-black text-emerald-400 italic font-mono flex justify-between"><span>Last Session Set 1:</span> <span>{lastSets[0].weight}kg x {lastSets[0].reps}</span></div>
                    )}
                  </div>
                ) : <div className="text-[11px] text-zinc-600 italic">First time logging this movement. Set the bar high.</div>}
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div className="bg-blue-500/5 p-3 rounded-2xl border border-blue-500/20 text-center">
                  <span className="text-[9px] uppercase font-black text-blue-500 tracking-widest block mb-1">My PB</span>
                  <div className="text-white font-mono text-sm font-black italic">{myPB ? `${myPB.weight}kg x ${myPB.reps}` : '--'}</div>
                </div>
                <div className="bg-emerald-500/5 p-3 rounded-2xl border border-emerald-500/20 text-center">
                  <span className="text-[9px] uppercase font-black text-emerald-500 tracking-widest block mb-1">{rival}'s PB</span>
                  <div className="text-white font-mono text-sm font-black italic">{rivalPB ? `${rivalPB.weight}kg x ${rivalPB.reps}` : '--'}</div>
                </div>
              </div>

              <div className="flex gap-4">
                <div className="flex-1">
                  <label className="text-[10px] font-black text-zinc-600 uppercase block mb-1">Weight</label>
                  <input type="number" value={weight} onChange={e => setWeight(e.target.value)} placeholder="0.0" className="w-full bg-black border-2 border-zinc-800 rounded-2xl p-4 text-white font-mono font-black text-xl outline-none focus:border-orange-500 text-center transition-all shadow-inner" />
                </div>
                <div className="flex-[1.5] min-w-0">
                  <label className="text-[10px] font-black text-zinc-600 uppercase block mb-1">Reps</label>
                  <div className="flex gap-2 overflow-x-auto pb-1 hide-scrollbar">
                    {REP_TARGETS.map(r => (
                      <button key={r} type="button" onClick={() => setReps(r.toString())} className={`w-14 h-14 rounded-2xl flex items-center justify-center font-mono font-black text-lg border-2 shrink-0 transition-all ${reps === r.toString() ? 'bg-orange-500 text-black border-orange-400 shadow-lg scale-105' : 'bg-zinc-950 text-zinc-500 border-zinc-800'}`}>{r}</button>
                    ))}
                  </div>
                </div>
              </div>

              <div>
                 <label className="text-[10px] font-black text-zinc-600 uppercase block mb-1">Set Notes / Trash Talk</label>
                 <input 
                    type="text" 
                    value={note}
                    onChange={e => setNote(e.target.value)}
                    placeholder="E.g. Felt light today..."
                    className="w-full bg-black border-2 border-zinc-800 rounded-2xl p-4 text-zinc-300 font-bold text-sm outline-none focus:border-orange-500 transition-all shadow-inner"
                  />
              </div>

              <button disabled={!weight || !exercise} className="w-full bg-orange-500 text-black font-black uppercase italic tracking-wider py-5 rounded-3xl active:scale-95 transition-all flex justify-center items-center gap-3 mt-4 shadow-[0_10px_30px_rgba(249,115,22,0.3)] disabled:opacity-50 text-lg">Log Data Point <IconPlus size={20}/></button>
            </form>
          </div>

          <div className="mt-8 mb-6">
              <h3 className="text-xs font-black text-zinc-500 uppercase tracking-widest mb-4">Today's Log ({todaysWorkouts.length} Sets)</h3>
              {todaysWorkouts.length === 0 ? (
                  <div className="text-zinc-600 text-sm text-center py-6 border border-dashed border-zinc-800 rounded-2xl">Nothing logged today yet.</div>
              ) : (
                  <div className="space-y-3">
                     {todaysWorkouts.map(w => (
                         <div key={w.id} className="flex items-center justify-between bg-zinc-900 border border-zinc-800 p-4 rounded-2xl">
                             <div>
                                 <div className="font-black text-white text-sm">{w.exercise}</div>
                                 <div className="font-mono text-orange-500 font-bold text-xs">{w.weight}kg x {w.reps}</div>
                                 {w.note && <div className="text-[10px] text-zinc-400 italic mt-1">"{w.note}"</div>}
                             </div>
                             <button onClick={() => handleDeleteSet(w.id)} className="text-zinc-600 hover:text-red-500 p-2 transition-colors"><IconTrash size={18}/></button>
                         </div>
                     ))}
                  </div>
              )}
          </div>
        </div>
      );
    }

    function Diet({ habits, localUser }) {
      const today = formatDate(new Date());
      const todayHabit = habits.find(h => h.user === localUser && h.date === today) || { calories: false, protein: false, water: false, noAlcohol: false };
      const checks = [
        { id: 'calories', label: 'Calorie Target Hit', icon: <IconFlame size={24} />, color: 'orange' },
        { id: 'protein', label: 'Protein Goal Smashed', icon: <IconUtensils size={24} />, color: 'red' },
        { id: 'water', label: 'Hydration - 3L+', icon: <IconActivity size={24} />, color: 'blue' },
        { id: 'noAlcohol', label: 'Dry Day - No Booze', icon: <IconBan size={24} />, color: 'emerald' },
      ];
      const toggle = async (id) => {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'habits', `${localUser}_${today}`), { user: localUser, date: today, timestamp: Date.now(), ...todayHabit, [id]: !todayHabit[id] });
      };
      return (
        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 pb-24">
          <h2 className="text-3xl font-black italic uppercase text-white mb-6 leading-tight">Daily Habit<br/>Accountability</h2>
          <div className="space-y-4">
            {checks.map(c => {
              const active = todayHabit[c.id];
              return (
                <button key={c.id} onClick={() => toggle(c.id)} className={`w-full flex items-center p-6 rounded-[2rem] border-2 transition-all active:scale-95 ${active ? `border-${c.color}-500 bg-${c.color}-500/10` : 'border-zinc-800 bg-zinc-950'}`}>
                  <div className={`w-14 h-14 rounded-2xl flex items-center justify-center mr-5 ${active ? `bg-${c.color}-500 text-black shadow-lg shadow-${c.color}-500/20` : 'bg-zinc-900 text-zinc-600'}`}>{c.icon}</div>
                  <span className={`font-black text-xl italic flex-1 text-left ${active ? 'text-white' : 'text-zinc-500'}`}>{c.label}</span>
                  <div className={`w-8 h-8 rounded-full border-4 flex items-center justify-center transition-all ${active ? `border-white bg-white` : 'border-zinc-800'}`}>{active && <IconActivity size={16} className="text-black" />}</div>
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    function History({ workouts, habits, profiles, localUser }) {
      const [viewUser, setViewUser] = useState(localUser);
      const [currentDate, setCurrentDate] = useState(new Date());
      const monthData = useMemo(() => {
        const w = new Set(); const d = new Set();
        workouts.forEach(x => { if(x.user === viewUser) w.add(x.date) });
        habits.forEach(x => { if(x.user === viewUser && x.calories && x.protein && x.water && x.noAlcohol) d.add(x.date) });
        return { w, d };
      }, [workouts, habits, viewUser]);
      const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
      const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
      const days = Array.from({length: daysInMonth}, (_, i) => i + 1);

      return (
        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 pb-24">
          <h2 className="text-3xl font-black italic uppercase text-white mb-6">Logs</h2>
          <div className="flex bg-zinc-900 rounded-2xl p-1.5 mb-8 border border-zinc-800 shadow-lg">
            {['Jordan','Aaron'].map(u => <button key={u} onClick={() => setViewUser(u)} className={`flex-1 py-3 rounded-xl text-sm font-black transition-all uppercase tracking-widest ${viewUser === u ? 'bg-orange-500 text-black shadow-md' : 'text-zinc-500 hover:text-zinc-300'}`}>{u}</button>)}
          </div>
          <div className="bg-zinc-950 p-6 rounded-[2.5rem] border border-zinc-800 shadow-2xl">
             <div className="flex justify-between items-center mb-8">
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-3 bg-zinc-900 rounded-2xl border border-zinc-800 text-orange-500">â†</button>
                <h3 className="font-black italic text-lg uppercase tracking-tighter">{currentDate.toLocaleString('default', { month: 'long', year:'numeric' })}</h3>
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-3 bg-zinc-900 rounded-2xl border border-zinc-800 text-orange-500">â†’</button>
             </div>
             <div className="grid grid-cols-7 gap-2 mb-4 text-center text-[10px] font-black text-zinc-700 uppercase tracking-widest">
               {['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(day => <div key={day}>{day}</div>)}
             </div>
             <div className="grid grid-cols-7 gap-2">
                {Array(firstDayOfMonth).fill(null).map((_, i) => <div key={i} />)}
                {days.map(d => {
                  const ds = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                  const isW = monthData.w.has(ds); const isD = monthData.d.has(ds);
                  return <div key={d} className={`aspect-square rounded-2xl flex items-center justify-center font-black text-sm relative border-2 transition-all ${isW ? 'bg-orange-500 text-black border-orange-300 shadow-[0_0_15px_rgba(249,115,22,0.3)]' : 'bg-zinc-900 text-zinc-500 border-zinc-800'}`}>{d}{isD && <div className={`absolute bottom-1 right-1 w-2.5 h-2.5 ${isW ? 'bg-white' : 'bg-blue-400'} rounded-full shadow-sm`} />}</div>
                })}
             </div>
          </div>
        </div>
      );
    }

    function Stats({ workouts, habits, profiles }) {
      const users = ['Jordan', 'Aaron'];
      const analytics = useMemo(() => {
        const calculate = (user) => {
          const prof = profiles[user] || {};
          const target = parseInt(prof.targetWorkouts || 4);
          const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          const workoutDays = new Set(workouts.filter(w => w.user === user && new Date(w.date) >= thirtyDaysAgo).map(w => w.date)).size;
          const consistency = Math.min(Math.round((workoutDays / (target * 4)) * 100), 100);
          const fourteenDaysAgo = new Date(); fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);
          const pbs = workouts.filter(w => w.user === user && w.timestamp >= fourteenDaysAgo.getTime()).reduce((acc, curr) => {
              const prev = workouts.filter(w => w.user === user && w.exercise === curr.exercise && w.timestamp < curr.timestamp);
              if (prev.length && curr.weight > Math.max(...prev.map(p => p.weight))) return acc + 1;
              return acc;
          }, 0);
          const perfDays = new Set(habits.filter(h => h.user === user && h.calories && h.protein && h.water && h.noAlcohol).map(h => h.date));
          let streak = 0; let d = new Date();
          while(perfDays.has(formatDate(d))) { streak++; d.setDate(d.getDate()-1); }
          const readiness = Math.round((consistency * 0.4) + (streak * 4) + (pbs * 6));
          return { consistency: isNaN(consistency) ? 0 : consistency, pbs, streak, readiness: isNaN(readiness) ? 0 : Math.min(readiness, 100) };
        };
        return { Jordan: calculate('Jordan'), Aaron: calculate('Aaron') };
      }, [workouts, habits, profiles]);

      useEffect(() => {
        const labels = []; const jVol = []; const aVol = [];
        for (let i = 13; i >= 0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i); const ds = formatDate(d);
            labels.push(d.toLocaleDateString('en-US', { day: 'numeric', month:'short' }));
            jVol.push(workouts.filter(w => w.user === 'Jordan' && w.date === ds).reduce((a,b) => a + (b.weight * b.reps), 0));
            aVol.push(workouts.filter(w => w.user === 'Aaron' && w.date === ds).reduce((a,b) => a + (b.weight * b.reps), 0));
        }
        const ctx = document.getElementById('volumeChart'); if (window.vChartInst) window.vChartInst.destroy();
        window.vChartInst = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [
                { label: 'Jordan', data: jVol, borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.05)', borderWidth: 3 },
                { label: 'Aaron', data: aVol, borderColor: '#10b981', tension: 0.4, fill: true, backgroundColor: 'rgba(16, 185, 129, 0.05)', borderWidth: 3 }
            ]},
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#18181b' }, border: {display: false}, ticks: {color: '#52525b'} }, x: { grid: { display: false }, ticks: {color: '#52525b'} } } }
        });
      }, [workouts]);

      const renderMetric = (label, jordanVal, aaronVal, suffix = "") => (
        <div className="space-y-3 mb-8">
          <div className="flex justify-between px-1"><span className="text-[10px] font-black uppercase text-zinc-500 tracking-[0.2em]">{label}</span></div>
          <div className="space-y-4">
            <div className="flex items-center gap-4">
              <span className="w-12 text-[10px] font-black text-blue-500 uppercase">Jord</span>
              <div className="flex-1 h-2.5 bg-zinc-950 rounded-full border border-zinc-800 overflow-hidden"><div className="h-full bg-blue-500 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(59,130,246,0.5)]" style={{ width: `${Math.min(jordanVal, 100)}%` }} /></div>
              <span className="w-10 text-xs font-mono font-black text-right text-white">{jordanVal}{suffix}</span>
            </div>
            <div className="flex items-center gap-4">
              <span className="w-12 text-[10px] font-black text-emerald-500 uppercase">Aar</span>
              <div className="flex-1 h-2.5 bg-zinc-950 rounded-full border border-zinc-800 overflow-hidden"><div className="h-full bg-emerald-500 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(16,185,129,0.5)]" style={{ width: `${Math.min(aaronVal, 100)}%` }} /></div>
              <span className="w-10 text-xs font-mono font-black text-right text-white">{aaronVal}{suffix}</span>
            </div>
          </div>
        </div>
      );

      return (
        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 pb-24">
          <h2 className="text-3xl font-black italic uppercase text-white mb-6 leading-tight">Transformation<br/>Analytics</h2>
          <div className="grid grid-cols-2 gap-4 mb-8">
            {users.map(u => (
              <div key={u} className="bg-zinc-900 border-2 border-zinc-800 p-6 rounded-[2.5rem] text-center relative overflow-hidden shadow-2xl">
                <div className={`absolute top-0 left-0 w-full h-1.5 ${u === 'Jordan' ? 'bg-blue-500' : 'bg-emerald-500'}`} />
                <span className="text-[10px] font-black text-zinc-500 uppercase tracking-[0.2em] block mb-2">{u} Score</span>
                <div className="text-6xl font-black text-white italic tracking-tighter">{analytics[u].readiness}</div>
                <div className="text-[11px] font-black text-orange-500 mt-2 italic">TURKEY READY</div>
              </div>
            ))}
          </div>
          <div className="bg-zinc-900/50 p-6 rounded-[2.5rem] border border-zinc-800 shadow-xl mb-8">
             <div className="flex items-center justify-between mb-6"><h3 className="text-xs font-black uppercase text-zinc-500 tracking-[0.2em]">Volume Power Graph</h3><div className="flex gap-4"><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-500"/> <span className="text-[9px] font-black uppercase text-zinc-600">J</span></div><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-emerald-500"/> <span className="text-[9px] font-black uppercase text-zinc-600">A</span></div></div></div>
             <div className="h-48 w-full"><canvas id="volumeChart"></canvas></div>
          </div>
          <div className="bg-zinc-900/30 p-8 rounded-[2.5rem] border border-zinc-800 shadow-xl">
             {renderMetric("Monthly Consistency", analytics.Jordan.consistency, analytics.Aaron.consistency, "%")}
             {renderMetric("Recent PBs Smashed", analytics.Jordan.pbs * 10, analytics.Aaron.pbs * 10, "")}
             {renderMetric("Current Diet Streak", analytics.Jordan.streak * 10, analytics.Aaron.streak * 10, "d")}
          </div>
        </div>
      );
    }

    function Profile({ profiles, localUser, onLogout }) {
      const prof = profiles[localUser] || {};
      const [form, setForm] = useState({ currentWeight: prof.currentWeight || '', goalWeight: prof.goalWeight || '', targetWorkouts: prof.targetWorkouts || '4', motivation: prof.motivation || '' });
      const [saveState, setSaveState] = useState('idle');

      const handleSave = async () => {
         setSaveState('saving');
         try { 
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', localUser), form);
            setSaveState('saved');
            setTimeout(() => setSaveState('idle'), 2500);
         } catch(e) {
            setSaveState('idle');
         }
      };

      return (
        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 pb-24">
          <h2 className="text-3xl font-black italic uppercase text-white mb-6">Profile & Goals</h2>
          <div className="bg-zinc-900 p-8 rounded-[2.5rem] border border-zinc-800 shadow-2xl space-y-6">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2"><label className="text-[10px] font-black text-zinc-500 uppercase tracking-widest block">Current (kg)</label><input type="number" value={form.currentWeight} onChange={e => setForm({...form, currentWeight: e.target.value})} className="w-full bg-black border border-zinc-800 rounded-2xl p-4 text-white font-black italic text-xl shadow-inner outline-none focus:border-orange-500 transition-all" /></div>
              <div className="space-y-2"><label className="text-[10px] font-black text-orange-500 uppercase tracking-widest block">Goal (kg)</label><input type="number" value={form.goalWeight} onChange={e => setForm({...form, goalWeight: e.target.value})} className="w-full bg-black border border-zinc-800 rounded-2xl p-4 text-orange-500 font-black italic text-xl shadow-inner outline-none focus:border-orange-500 transition-all" /></div>
            </div>
            <div className="space-y-3"><label className="text-[10px] font-black text-zinc-500 uppercase tracking-widest block">Weekly Sessions: {form.targetWorkouts}</label><input type="range" min="1" max="7" value={form.targetWorkouts} onChange={e => setForm({...form, targetWorkouts: e.target.value})} className="w-full accent-orange-500" /></div>
            <div className="space-y-2"><label className="text-[10px] font-black text-zinc-500 uppercase tracking-widest block">Your Motivation</label><textarea value={form.motivation} onChange={e => setForm({...form, motivation: e.target.value})} className="w-full bg-black border border-zinc-800 rounded-2xl p-4 text-sm text-zinc-300 font-bold italic shadow-inner outline-none focus:border-orange-500 transition-all" rows="2" /></div>
            
            <button 
               onClick={handleSave} 
               disabled={saveState === 'saving'}
               className={`w-full font-black uppercase py-5 rounded-3xl shadow-[0_10px_30px_rgba(249,115,22,0.3)] transition-all active:scale-95 text-lg italic ${saveState === 'saved' ? 'bg-emerald-500 text-black shadow-[0_10px_30px_rgba(16,185,129,0.3)]' : 'bg-orange-500 text-black'}`}
            >
               {saveState === 'idle' ? 'Lock Protocol' : saveState === 'saving' ? 'Locking...' : 'Protocol Locked! âœ“'}
            </button>
            
            <button onClick={onLogout} className="w-full bg-zinc-800 text-zinc-500 font-black uppercase py-4 rounded-3xl active:scale-95 transition-all text-sm tracking-widest">Switch User Identity</button>
          </div>
        </div>
      );
    }

    function NavBar({ activeTab, setActiveTab }) {
      const tabs = [
        { id: 'hub', icon: <IconActivity size={24} />, label: 'Hub' },
        { id: 'train', icon: <IconPlus size={24} />, label: 'Train' },
        { id: 'diet', icon: <IconUtensils size={24} />, label: 'Habits' },
        { id: 'history', icon: <IconCalendar size={24} />, label: 'Log' },
        { id: 'vs', icon: <IconFlame size={24} />, label: 'VS' },
        { id: 'profile', icon: <IconUser size={24} />, label: 'Goal' },
      ];
      return (
        <nav className="fixed bottom-0 w-full max-w-md left-1/2 -translate-x-1/2 bg-zinc-950/90 backdrop-blur-xl border-t border-zinc-800/50 flex justify-around p-3 pb-safe z-50 shadow-[0_-10px_30px_rgba(0,0,0,0.5)]">
          {tabs.map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center gap-1.5 p-2 rounded-2xl transition-all ${activeTab === tab.id ? 'text-orange-500 scale-110' : 'text-zinc-500 hover:text-zinc-300'}`}>
              {tab.icon} <span className="text-[8px] font-black uppercase tracking-widest">{tab.label}</span>
            </button>
          ))}
        </nav>
      );
    }

    // --- MAIN APP ---
    function App() {
      const [authUser, setAuthUser] = useState(null);
      const [localUser, setLocalUser] = useState(localStorage.getItem('ts_user') || null);
      const [activeTab, setActiveTab] = useState('hub');
      const [workouts, setWorkouts] = useState([]);
      const [habits, setHabits] = useState([]);
      const [profiles, setProfiles] = useState({});
      const [exerciseDB, setExerciseDB] = useState([]);
      const [customExercises, setCustomExercises] = useState([]);
      const [gauntlet, setGauntlet] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const initAuth = async () => {
          try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
          } catch (error) {
            console.error("Auth error:", error);
          }
        };

        const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
          if (user) setAuthUser(user);
          else initAuth();
        });

        fetch(DB_URL).then(res => res.json()).then(setExerciseDB).catch(e => {});
        return () => unsubscribeAuth();
      }, []);

      useEffect(() => {
        if (!authUser) return;

        const wQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'workouts'));
        const hQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'habits'));
        const pQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'));
        const cQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'custom_exercises'));
        const gDoc = doc(db, 'artifacts', appId, 'public', 'data', 'gauntlet', 'current');

        const unsubW = onSnapshot(wQuery, s => setWorkouts(s.docs.map(d => ({id:d.id, ...d.data()}))), (err) => console.error("Workouts Error:", err));
        const unsubH = onSnapshot(hQuery, s => setHabits(s.docs.map(d => ({id:d.id, ...d.data()}))), (err) => console.error("Habits Error:", err));
        const unsubP = onSnapshot(pQuery, s => { 
          const p={}; s.docs.forEach(d => p[d.id]=d.data()); 
          setProfiles(p); 
          setLoading(false); 
        }, (err) => { console.error("Profiles Error:", err); setLoading(false); });
        const unsubC = onSnapshot(cQuery, s => setCustomExercises(s.docs.map(d => ({id:d.id, ...d.data()}))), (err) => console.error("Custom Exercises Error:", err));
        
        const unsubG = onSnapshot(gDoc, (d) => {
           if (d.exists()) setGauntlet(d.data());
           else setGauntlet(null);
        }, (err) => console.error("Gauntlet Error:", err));

        return () => { unsubW(); unsubH(); unsubP(); unsubC(); unsubG(); };
      }, [authUser]);

      if (!localUser) return <WelcomeScreen onSelect={(u) => { localStorage.setItem('ts_user', u); setLocalUser(u); }} />;
      if (loading) return <div className="min-h-screen bg-zinc-950 flex flex-col items-center justify-center gap-4 text-orange-500 font-black italic uppercase animate-pulse"><IconFlame size={64} className="animate-bounce" /> Loading Protocol...</div>;

      return (
        <div className="min-h-screen bg-zinc-950 text-slate-50 font-sans selection:bg-orange-500/30 overflow-x-hidden">
          <Header localUser={localUser} />
          <main className="p-4 max-w-md mx-auto pt-6">
            {activeTab === 'hub' && (
              <>
                <Gauntlet gauntlet={gauntlet} localUser={localUser} />
                <Feed workouts={workouts} habits={habits} localUser={localUser} />
              </>
            )}
            {activeTab === 'train' && <Train workouts={workouts} localUser={localUser} exerciseDB={exerciseDB} customExercises={customExercises} />}
            {activeTab === 'diet' && <Diet habits={habits} localUser={localUser} />}
            {activeTab === 'history' && <History workouts={workouts} habits={habits} profiles={profiles} localUser={localUser} />}
            {activeTab === 'vs' && <Stats workouts={workouts} habits={habits} profiles={profiles} />}
            {activeTab === 'profile' && <Profile profiles={profiles} localUser={localUser} onLogout={() => { localStorage.removeItem('ts_user'); setLocalUser(null); }} />}
          </main>
          <NavBar activeTab={activeTab} setActiveTab={setActiveTab} />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
